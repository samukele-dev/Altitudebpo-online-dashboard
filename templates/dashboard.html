<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Altitude BPO Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'logo-blue': '#4D96FF',
                        'logo-purple': '#9C78E4',
                        'light-bg': '#FFFFFF',
                        'light-card-bg': '#F9FAFB',
                        'light-header-bg': '#FFFFFF',
                        'light-text': '#1F2937',
                        'light-border': '#E5E7EB',
                        'primary-accent': '#4D96FF',
                        'secondary-accent': '#9C78E4',
                        'success-icon': '#10B981',
                        'danger-icon': '#EF4444',
                    },
                    animation: {
                        'countdown-pulse': 'countdown-pulse 1s ease-in-out infinite'
                    },
                    keyframes: {
                        'countdown-pulse': {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.7' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            padding-left: 3rem;
            padding-right: 3rem;
            overflow-x: hidden;
        }

        .dashboard-dropdown {
            position: relative;
            display: inline-block;
        }

        .dashboard-dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 120px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .dashboard-dropdown-content.show {
            display: block;
        }

        .dashboard-option {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f1f1f1;
            transition: background-color 0.2s;
        }

        .dashboard-option:hover {
            background-color: #f8f9fa;
        }

        .dashboard-option:last-child {
            border-bottom: none;
        }

        .dashboard-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .dashboard-badge:hover {
            transform: scale(1.05);
        }

        .badge-global {
            background-color: #E3F2FD;
            color: #1976D2;
            border: 1px solid #90CAF9;
        }

        .badge-floor1 {
            background-color: #E8F5E8;
            color: #2E7D32;
            border: 1px solid #A5D6A7;
        }

        .badge-floor2 {
            background-color: #FFF3E0;
            color: #EF6C00;
            border: 1px solid #FFCC80;
        }

        /* Breakdown Modal Styles */
        .breakdown-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .breakdown-modal.open {
            display: flex;
            opacity: 1;
        }

        .breakdown-modal-content {
            background-color: white;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            transform: translateY(-100%);
            opacity: 0;
            animation: fly-in 0.8s ease-out forwards;
            max-width: 500px;
            width: 90%;
        }

        @keyframes fly-in {
            0% { transform: translateY(-100%); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        .countdown-timer {
            background: linear-gradient(135deg, #4D96FF, #9C78E4);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(77, 150, 255, 0.3);
        }

        .breakdown-item {
            transition: all 0.2s ease;
        }

        .breakdown-item:hover {
            background: #f8fafc;
            transform: translateY(-1px);
        }
    </style>
</head>

<body class="bg-light-bg text-light-text min-h-screen">

    <!-- Breakdown Popup Modal -->
    <div id="breakdown-modal" class="breakdown-modal">
        <div class="breakdown-modal-content">
            <div class="flex justify-between items-center mb-6 border-b pb-3">
                <h2 class="text-3xl font-extrabold text-primary-accent">Sales Breakdown</h2>
                <div class="flex items-center space-x-4">
                    <div id="breakdown-countdown" class="countdown-timer text-sm">
                        Closing in: <span id="countdown-display">03:30</span>
                    </div>
                    <button id="close-breakdown-modal-btn" class="text-gray-500 hover:text-danger-icon">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
            </div>
            <div id="breakdown-data" class="space-y-6">
                <!-- Default content when no data is available -->
                <div class="team-section">
                    <h3 class="text-xl font-bold text-gray-800 mb-4"></h3>
                    
                    <!-- No data message -->
                    <div class="text-center py-8">
                        <div class="text-gray-500 text-lg mb-2">No breakdown data available</div>
                        <div class="countdown-timer text-sm inline-block">
                            Closing in: <span>03:30</span>
                        </div>
                    </div>
                </div>
                
                
            </div>
        </div>
    </div>

    <div class="mx-auto">
        <div class="bg-light-header-bg p-4 rounded-lg shadow-lg flex flex-col md:flex-row justify-between items-center mb-6 border-b border-light-border">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Altitude BPO Logo"
                class="h-10 w-auto mr-auto">
            <p class="text-xl font-bold text-primary-accent mr-auto ml-4 hidden md:block">
                {{ user_group }} Dashboard
            </p>
            <div class="flex space-x-4 mt-4 md:mt-0">
                {% if user_group == 'Global' %}
                <form action="{{ url_for('admin_upload_team_file') }}" method="post" enctype="multipart/form-data" class="flex">
                    <label for="team-file-upload"
                        class="flex items-center text-white bg-primary-accent hover:bg-primary-accent/90 px-4 py-2 rounded-lg transition duration-200 shadow-md text-md cursor-pointer">
                        <i class="fas fa-file-upload mr-2"></i> Team Stats
                    </label>
                    <input type="file" name="file" id="team-file-upload" required class="hidden" 
                        onchange="this.form.submit()">
                </form>
                {% endif %}

                <form action="{{ url_for('upload_breakdown_file') }}" method="post" enctype="multipart/form-data" class="flex" id="breakdown-form">
                    {% if user_group == 'Global' %}
                    <div class="flex flex-col">
                        <label for="breakdown-file-upload"
                            class="flex items-center text-white bg-secondary-accent hover:bg-secondary-accent/90 px-4 py-2 rounded-lg transition duration-200 shadow-md text-md cursor-pointer">
                            <i class="fas fa-chart-pie mr-2"></i> Breakdown
                        </label>
                    </div>
                    {% else %}
                    <label for="breakdown-file-upload"
                        class="flex items-center text-white bg-secondary-accent hover:bg-secondary-accent/90 px-4 py-2 rounded-lg transition duration-200 shadow-md text-md cursor-pointer">
                        <i class="fas fa-chart-pie mr-2"></i> Breakdown
                    </label>
                    {% endif %}
                    <input type="file" name="breakdown_file" id="breakdown-file-upload" required class="hidden">
                </form>

                <a href="{{ url_for('logout') }}"
                    class="flex items-center text-light-text hover:bg-gray-100 border border-light-border px-4 py-2 rounded-lg transition duration-200 shadow-sm text-md">
                    <i class="fas fa-sign-out-alt mr-2"></i> Logout
                </a>
            </div>
        </div>
    </div>

    <div id="dashboard-content" class="mx-auto">
        <h1 class="text-3xl font-extrabold text-primary-accent p-6 text-center">
            Vodacom Funeral Sales Performance Update
        </h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="mb-4" id="flash-messages-container">
            {% for category, message in messages %}
            <div class="p-3 mb-2 rounded-lg font-semibold flex items-center border 
                {% if category == 'success' %} bg-green-50 text-green-800 border-green-300
                {% elif category == 'danger' %} bg-red-50 text-red-800 border-red-300
                {% else %} bg-blue-50 text-blue-800 border-blue-300
                {% endif %}">
                <i class="
                    {% if category == 'success' %} fas fa-check-circle text-green-500
                    {% elif category == 'danger' %} fas fa-exclamation-circle text-red-500
                    {% else %} fas fa-info-circle text-blue-500
                    {% endif %} mr-2"></i>
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        {% if stats is not none %}
        <div id="kpi-cards" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-light-card-bg p-4 rounded-xl shadow-md border-b-4 border-primary-accent">
                <div class="flex items-end justify-between">
                    <p class="text-4xl lg:text-5xl font-extrabold text-light-text">
                        {{ totals['Total Target'] | int | to_localized_string }}
                    </p>
                    <div class="flex flex-col items-end">
                        <p class="text-sm font-medium uppercase text-gray-500">Total Target</p>
                        <i class="fas fa-crosshairs text-3xl opacity-50 text-primary-accent"></i>
                    </div>
                </div>
            </div>

            <div class="bg-light-card-bg p-6 rounded-xl shadow-md border-b-4 border-secondary-accent">
                <div class="flex items-end justify-between">
                    <p class="text-4xl lg:text-5xl font-extrabold text-light-text">
                        {{ totals['Total Current'] | int | to_localized_string }}
                    </p>
                    <div class="flex flex-col items-end">
                        <p class="text-sm font-medium uppercase text-gray-500">Total Current</p>
                        <i class="fas fa-hand-holding-usd text-3xl opacity-50 text-secondary-accent"></i>
                    </div>
                </div>
            </div>

            <div class="bg-light-card-bg p-6 rounded-xl shadow-md border-b-4 
                {% if totals['Total Shortfall'] > 0 %} border-danger-icon
                {% elif totals['Total Shortfall'] < 0 %} border-success-icon
                {% else %} border-gray-400
                {% endif %}">
                <div class="flex items-end justify-between">
                    <p class="text-4xl lg:text-5xl font-extrabold 
                        {% if totals['Total Shortfall'] > 0 %} text-danger-icon
                        {% elif totals['Total Shortfall'] < 0 %} text-success-icon
                        {% else %} text-light-text
                        {% endif %}">
                        {{ totals['Total Shortfall'] | int | to_localized_string }}
                    </p>
                    <div class="flex flex-col items-end">
                        <p class="text-sm font-medium uppercase text-gray-500">Total Shortfall</p>
                        <i class="fas fa-minus-circle text-3xl opacity-50 
                            {% if totals['Total Shortfall'] > 0 %} text-danger-icon
                            {% elif totals['Total Shortfall'] < 0 %} text-success-icon
                            {% else %} text-gray-400
                            {% endif %}"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-light-card-bg p-6 rounded-xl shadow-lg">
            <div class="overflow-x-auto rounded-lg shadow-sm border border-light-border">
                <table class="min-w-full table-auto">
                    <thead class="bg-primary-accent text-white">
                        <tr>
                            <th class="p-3 text-left tracking-wider uppercase text-sm">Team</th>
                            <th class="p-3 text-left tracking-wider uppercase text-sm">Target</th>
                            <th class="p-3 text-left tracking-wider uppercase text-sm">Current</th>
                            <th class="p-3 text-left tracking-wider uppercase text-sm">Shortfall</th>
                            <th class="p-3 text-center tracking-wider uppercase text-sm">Status</th>
                            {% if user_group == 'Global' %}
                            <th class="p-3 text-center tracking-wider uppercase text-sm">Dashboard</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody id="stats-table-body" class="divide-y divide-light-border bg-white">
                        {% for row in stats %}
                        <tr class="hover:bg-gray-50 transition duration-150">
                            <td class="p-3 font-medium">{{ row.Team }}</td>
                            <td class="p-3 text-lg font-bold">{{ row.Target | int | to_localized_string }}</td>
                            <td class="p-3 text-lg font-bold">{{ row.Current | int | to_localized_string }}</td>
                            <td class="p-3 text-lg font-bold 
                                {% if row.Shortfall > 0 %} text-danger-icon
                                {% elif row.Shortfall < 0 %} text-success-icon
                                {% else %} text-gray-500
                                {% endif %}">
                                {{ row.Shortfall | int | to_localized_string }}
                            </td>
                            <td class="p-3 text-center">
                                {% if row.Current >= row.Target %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-success-icon border border-green-200">
                                    <i class="fas fa-check-circle mr-1"></i> On Target
                                </span>
                                {% else %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-danger-icon border border-red-200">
                                    <i class="fas fa-exclamation-triangle mr-1"></i> Behind
                                </span>
                                {% endif %}
                            </td>
                            {% if user_group == 'Global' %}
                            <td class="p-3 text-center">
                                <div class="dashboard-dropdown">
                                    {% set current_dashboard = allocation_data.get(row.Team, 'Global') %}
                                    <div class="dashboard-badge 
                                        {% if current_dashboard == 'Global' %} badge-global
                                        {% elif current_dashboard == 'Floor 1' %} badge-floor1
                                        {% else %} badge-floor2
                                        {% endif %}"
                                        onclick="toggleDashboardDropdown('{{ row.Team }}')">
                                        {{ current_dashboard }}
                                        <i class="fas fa-chevron-down ml-1 text-xs"></i>
                                    </div>
                                    <div id="dropdown-{{ row.Team | replace(' ', '-') }}" class="dashboard-dropdown-content">
                                        <div class="dashboard-option" onclick="assignDashboard('{{ row.Team }}', 'Global')">
                                            <i class="fas fa-globe mr-2 text-blue-500"></i> Global
                                        </div>
                                        <div class="dashboard-option" onclick="assignDashboard('{{ row.Team }}', 'Floor 1')">
                                            <i class="fas fa-building mr-2 text-green-500"></i> Floor 1
                                        </div>
                                        <div class="dashboard-option" onclick="assignDashboard('{{ row.Team }}', 'Floor 2')">
                                            <i class="fas fa-building mr-2 text-orange-500"></i> Floor 2
                                        </div>
                                    </div>
                                </div>
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <div class="p-10 text-center bg-light-card-bg border border-light-border rounded-lg shadow-sm">
            <p class="text-xl text-gray-500 mb-5 flex items-center justify-center">
                <i class="fas fa-exclamation-circle mr-3 text-secondary-accent text-3xl"></i>
                No call centre data uploaded yet for {{ user_group }}.
            </p>
            {% if user_group == 'Global' %}
            <a href="{{ url_for('admin_upload_team_file') }}"
                class="inline-block bg-primary-accent hover:bg-primary-accent/90 text-white font-bold py-2 px-6 rounded-full transition duration-300 transform hover:scale-105 shadow-md">
                <i class="fas fa-file-upload mr-2"></i> Upload Team Stats file now
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // Global variables
        let breakdownModalTimer = null;
        const BREAKDOWN_MODAL_DURATION = 3.5 * 60 * 1000; // 3.5 minutes in milliseconds (03:30)

        // Elements
        const breakdownModal = document.getElementById('breakdown-modal');
        const closeBreakdownModalBtn = document.getElementById('close-breakdown-modal-btn');
        const countdownDisplay = document.getElementById('countdown-display');
        const breakdownData = document.getElementById('breakdown-data');
        const breakdownFileInput = document.getElementById('breakdown-file-upload');

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.matches('.dashboard-badge')) {
                const dropdowns = document.getElementsByClassName('dashboard-dropdown-content');
                for (let i = 0; i < dropdowns.length; i++) {
                    dropdowns[i].classList.remove('show');
                }
            }
        });

        function toggleDashboardDropdown(teamName) {
            const dropdownId = 'dropdown-' + teamName.replace(/ /g, '-');
            const dropdown = document.getElementById(dropdownId);
            
            // Close all other dropdowns
            const allDropdowns = document.getElementsByClassName('dashboard-dropdown-content');
            for (let i = 0; i < allDropdowns.length; i++) {
                if (allDropdowns[i].id !== dropdownId) {
                    allDropdowns[i].classList.remove('show');
                }
            }
            
            // Toggle current dropdown
            dropdown.classList.toggle('show');
        }

        function assignDashboard(teamName, dashboard) {
            console.log(`Assigning team ${teamName} to ${dashboard}`);
            
            // Close dropdown
            const dropdownId = 'dropdown-' + teamName.replace(/ /g, '-');
            document.getElementById(dropdownId).classList.remove('show');
            
            // Send assignment to server
            fetch('{{ url_for("set_dashboard_assignment") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    team_name: teamName,
                    dashboard: dashboard
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Update the badge visually
                    const badge = document.querySelector(`#dropdown-${teamName.replace(/ /g, '-')}`).previousElementSibling;
                    badge.textContent = dashboard;
                    badge.className = 'dashboard-badge ' + 
                        (dashboard === 'Global' ? 'badge-global' : 
                         dashboard === 'Floor 1' ? 'badge-floor1' : 'badge-floor2');
                    badge.innerHTML = dashboard + ' <i class="fas fa-chevron-down ml-1 text-xs"></i>';
                    
                    console.log(data.message);
                } else {
                    console.error('Error:', data.message);
                }
            })
            .catch(error => {
                console.error('Error assigning dashboard:', error);
            });
        }

        /**
         * Handle breakdown file upload and show popup modal
         */
        function handleBreakdownUpload() {
            const file = breakdownFileInput.files[0];
            if (!file) return;

            // Show the breakdown modal immediately
            showBreakdownModal();
            
            // Create FormData and submit via fetch instead of form submission
            const formData = new FormData();
            formData.append('breakdown_file', file);
            
            // Add target floors for Global users
            {% if user_group == 'Global' %}
            formData.append('breakdown_target_floors', 'Global');
            formData.append('breakdown_target_floors', 'Floor 1');
            formData.append('breakdown_target_floors', 'Floor 2');
            {% endif %}

            fetch('{{ url_for("upload_breakdown_file") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.redirected) {
                    // The server is redirecting, which means the upload was successful
                    // We'll let the page reload naturally to show the flash message
                    console.log('Upload successful, page will reload');
                } else {
                    return response.text();
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
            });
        }

        /**
         * Show the breakdown modal with countdown timer
         */
        function showBreakdownModal() {
            console.log('ðŸ”„ Showing breakdown modal');
            
            // Clear any existing timer
            if (breakdownModalTimer) {
                clearInterval(breakdownModalTimer);
            }

            // Show the modal
            breakdownModal.classList.add('open');
            
            // Fetch and display breakdown data
            fetchBreakdownData();
            
            let timeLeft = BREAKDOWN_MODAL_DURATION / 1000; // Convert to seconds
            
            // Update countdown display immediately
            updateCountdownDisplay(timeLeft);
            
            // Start countdown timer
            breakdownModalTimer = setInterval(() => {
                timeLeft--;
                updateCountdownDisplay(timeLeft);
                
                if (timeLeft <= 0) {
                    closeBreakdownModal();
                }
            }, 1000);
        }

        /**
         * Update the countdown display
         */
        function updateCountdownDisplay(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            countdownDisplay.textContent = display;
            
            // Add pulsing animation when under 1 minute
            if (seconds <= 60) {
                countdownDisplay.classList.add('animate-countdown-pulse');
            } else {
                countdownDisplay.classList.remove('animate-countdown-pulse');
            }
        }

        /**
         * Fetch breakdown data from the server
         */
        function fetchBreakdownData() {
            fetch('{{ url_for("get_sales_breakdown") }}')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received breakdown data:', data);
                    renderBreakdownData(data.breakdown);
                })
                .catch(error => {
                    console.error('Error fetching breakdown data:', error);
                    renderBreakdownData(null);
                });
        }

        /**
         * Render breakdown data in the modal - Updated to match image structure
         */
        function renderBreakdownData(breakdown) {
            if (!breakdown || breakdown.length === 0) {
                breakdownData.innerHTML = `
                    <div class="team-section">
                        <h3 class="text-xl font-bold text-gray-800 mb-4"></h3>
                        
                        <!-- No data message -->
                        <div class="text-center py-8">
                            <div class="text-gray-500 text-lg mb-2">No breakdown data available</div>
                            <div class="countdown-timer text-sm inline-block">
                                Closing in: <span>03:30</span>
                            </div>
                        </div>
                    </div>
                    

                `;
                return;
            }

            let html = '';
            
            // Team Section
            html += `
                <div class="team-section">
                    <h3 class="text-xl font-bold text-gray-800 mb-4"></h3>
            `;

            // Breakdown Categories
            const categories = ['Vodacom Funeral', 'Media', 'Upsell'];
            let hasCategories = false;
            
            categories.forEach(category => {
                const item = breakdown.find(d => d.Category === category || d.Team === category);
                if (item) {
                    hasCategories = true;
                    const value = item.Value || item.Target || item.Current || 0;
                    html += `
                        <div class="breakdown-item flex justify-between items-center p-3 bg-gray-50 rounded-lg mb-3">
                            <span class="font-semibold text-gray-700">${category}</span>
                            <span class="text-lg font-bold text-primary-accent">${formatNumber(value)}</span>
                        </div>
                    `;
                }
            });

            if (!hasCategories) {
                html += `
                    <div class="text-center py-8">
                        <div class="text-gray-500 text-lg mb-2">No breakdown data available</div>
                        <div class="countdown-timer text-sm inline-block">
                            Closing in: <span>03:30</span>
                        </div>
                    </div>
                `;
            }

            // Total Sales
            const totalSalesItem = breakdown.find(d => d.Category === 'Total Sales' || d.Team === 'Total Sales');
            if (totalSalesItem) {
                const totalSales = totalSalesItem.Value || totalSalesItem.Target || totalSalesItem.Current || 0;
                html += `
                    <div class="total-sales-section mt-6 pt-4 border-t border-gray-200">
                        <div class="flex justify-between items-center">
                            <span class="text-xl font-bold text-gray-800">Total Sales</span>
                            <span class="text-2xl font-extrabold text-success-icon">${formatNumber(totalSales)}</span>
                        </div>
                    </div>
                `;
            }

            html += `</div>`; // Close team-section

            // Current Total - Try to find current value in breakdown data
            let totalCurrent = 290; // Default fallback
            const currentItem = breakdown.find(d => d.Current) || breakdown.find(d => d.Team === 'TOTAL CURRENT');
            if (currentItem) {
                totalCurrent = currentItem.Current || currentItem.Value || 290;
            }

            html += `
                
            `;

            breakdownData.innerHTML = html;
        }

        /**
         * Format numbers with commas
         */
        function formatNumber(num) {
            const numericValue = typeof num === 'string' ? parseFloat(num) : num;
            if (isNaN(numericValue)) return '0';
            return numericValue.toLocaleString('en-US', { maximumFractionDigits: 0 });
        }

        /**
         * Close the breakdown modal
         */
        function closeBreakdownModal() {
            if (breakdownModalTimer) {
                clearInterval(breakdownModalTimer);
                breakdownModalTimer = null;
            }
            breakdownModal.classList.remove('open');
        }

        // Event listeners for breakdown modal
        closeBreakdownModalBtn.addEventListener('click', closeBreakdownModal);
        breakdownModal.addEventListener('click', (e) => {
            if (e.target.id === 'breakdown-modal') {
                closeBreakdownModal();
            }
        });

        // Setup file input change listener
        breakdownFileInput.addEventListener('change', handleBreakdownUpload);

        // Socket.IO for real-time updates
        if (typeof io !== 'undefined') {
            const socket = io();

            socket.on('connect', () => {
                console.log('Socket.IO connected');
                socket.emit('join_dashboard', { group: '{{ user_group }}' });
            });

            socket.on('data_updated', (data) => {
                console.log('Data updated received:', data);
                if (data.group === '{{ user_group }}' || data.group === 'Global') {
                    window.location.reload();
                }
            });
        }

        // Check if we should show breakdown modal on page load (for Global users after upload)
        document.addEventListener('DOMContentLoaded', () => {
            const hasBreakdownSuccess = document.querySelector('.flash-message.bg-green-50') !== null;
            const isGlobalUser = '{{ user_group }}' === 'Global';
            
            if (hasBreakdownSuccess) {
                // Small delay to ensure page is fully loaded
                setTimeout(() => {
                    showBreakdownModal();
                }, 1000);
            }
        });
    </script>
</body>
</html>